<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMORTS Test Client</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        h1 {
            color: #4CAF50;
        }
        .container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }
        .panel {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #2d5016;
            color: #7dff4d;
        }
        .status.disconnected {
            background-color: #501616;
            color: #ff4d4d;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            font-size: 14px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        input[type="text"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        .messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 10px;
            background-color: #1a1a1a;
            margin-bottom: 10px;
        }
        .message {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
            background-color: #2a2a2a;
        }
        .message.sent {
            background-color: #1a3a1a;
        }
        .message.received {
            background-color: #1a1a3a;
        }
        .message.system {
            background-color: #3a3a1a;
            font-style: italic;
        }
        .message.error {
            background-color: #3a1a1a;
            color: #ff6b6b;
        }
        .timestamp {
            font-size: 0.85em;
            color: #888;
            margin-right: 8px;
        }
        .message-type {
            font-weight: bold;
            margin-right: 8px;
            color: #4CAF50;
        }
        .info-section {
            margin-bottom: 15px;
        }
        .info-label {
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }
        .info-value {
            color: #ccc;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        .chat-input-container input {
            flex: 1;
            margin-bottom: 0;
        }
        .chat-input-container button {
            width: auto;
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <h1>ðŸŽ® MMORTS Test Client</h1>

    <div class="container">
        <!-- Left Panel: Connection & Controls -->
        <div>
            <div class="panel">
                <h3>Connection</h3>
                <div id="status" class="status disconnected">Disconnected</div>

                <input type="text" id="wsUrl" placeholder="WebSocket URL" value="ws://localhost:8080/ws">

                <button id="connectBtn" onclick="connect()">Connect</button>
                <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
                <button id="joinBtn" onclick="join()" disabled>Join Session</button>
                <button id="pingBtn" onclick="ping()" disabled>Send Ping</button>
            </div>

            <div class="panel">
                <h3>Session Info</h3>
                <div class="info-section">
                    <div class="info-label">Player ID:</div>
                    <div class="info-value" id="playerId">-</div>
                </div>
                <div class="info-section">
                    <div class="info-label">Username:</div>
                    <div class="info-value" id="username">-</div>
                </div>
                <div class="info-section">
                    <div class="info-label">Session ID:</div>
                    <div class="info-value" id="sessionId">-</div>
                </div>
                <div class="info-section">
                    <div class="info-label">Players Online:</div>
                    <div class="info-value" id="playerCount">0</div>
                </div>
                <div class="info-section">
                    <div class="info-label">Session State:</div>
                    <div class="info-value" id="sessionState">-</div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Messages & Chat -->
        <div class="panel">
            <h3>Messages</h3>
            <div id="messages" class="messages"></div>

            <h3>Chat</h3>
            <div class="chat-input-container">
                <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="handleChatKeypress(event)" disabled>
                <button onclick="sendChat()" id="chatBtn" disabled>Send</button>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let connected = false;

        function connect() {
            const url = document.getElementById('wsUrl').value;
            addMessage('system', `Connecting to ${url}...`);

            try {
                ws = new WebSocket(url);

                ws.onopen = () => {
                    connected = true;
                    updateConnectionStatus(true);
                    addMessage('system', 'Connected to server');
                };

                ws.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);
                        handleServerMessage(msg);
                    } catch (e) {
                        addMessage('error', `Failed to parse message: ${e.message}`);
                    }
                };

                ws.onclose = () => {
                    connected = false;
                    updateConnectionStatus(false);
                    addMessage('system', 'Disconnected from server');
                };

                ws.onerror = (error) => {
                    addMessage('error', `WebSocket error: ${error.message || 'Unknown error'}`);
                };
            } catch (e) {
                addMessage('error', `Connection failed: ${e.message}`);
            }
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function join() {
            if (!ws || !connected) {
                addMessage('error', 'Not connected to server');
                return;
            }

            const msg = {
                type: 'join',
                payload: {}
            };

            ws.send(JSON.stringify(msg));
            addMessage('sent', 'Sent join request');
        }

        function ping() {
            if (!ws || !connected) {
                addMessage('error', 'Not connected to server');
                return;
            }

            const msg = {
                type: 'ping',
                payload: {}
            };

            ws.send(JSON.stringify(msg));
            addMessage('sent', 'Sent ping');
        }

        function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            if (!ws || !connected) {
                addMessage('error', 'Not connected to server');
                return;
            }

            const msg = {
                type: 'chat',
                payload: {
                    message: message
                }
            };

            ws.send(JSON.stringify(msg));
            addMessage('sent', `Chat: ${message}`);
            input.value = '';
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendChat();
            }
        }

        function handleServerMessage(msg) {
            switch (msg.type) {
                case 'welcome':
                    addMessage('received', `Welcome! Player ID: ${msg.payload.player_id}`);
                    document.getElementById('playerId').textContent = msg.payload.player_id;
                    document.getElementById('username').textContent = msg.payload.username;
                    document.getElementById('sessionId').textContent = msg.payload.session_id;
                    updateSessionStatus(msg.payload.session_status);
                    break;

                case 'player_joined':
                    addMessage('received', `Player joined: ${msg.payload.username} (${msg.payload.player_id})`);
                    break;

                case 'player_left':
                    addMessage('received', `Player left: ${msg.payload.username} (${msg.payload.player_id})`);
                    break;

                case 'chat':
                    addMessage('received', `${msg.payload.username}: ${msg.payload.message}`);
                    break;

                case 'pong':
                    addMessage('received', `Pong received (timestamp: ${msg.payload.timestamp})`);
                    break;

                case 'error':
                    addMessage('error', `Error [${msg.payload.code}]: ${msg.payload.message}`);
                    break;

                default:
                    addMessage('received', `Unknown message type: ${msg.type}`);
                    console.log('Full message:', msg);
            }
        }

        function updateSessionStatus(status) {
            document.getElementById('playerCount').textContent = `${status.player_count} / ${status.max_players}`;
            document.getElementById('sessionState').textContent = status.state;
        }

        function updateConnectionStatus(isConnected) {
            const statusEl = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const joinBtn = document.getElementById('joinBtn');
            const pingBtn = document.getElementById('pingBtn');
            const chatInput = document.getElementById('chatInput');
            const chatBtn = document.getElementById('chatBtn');

            if (isConnected) {
                statusEl.textContent = 'Connected';
                statusEl.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                joinBtn.disabled = false;
                pingBtn.disabled = false;
                chatInput.disabled = false;
                chatBtn.disabled = false;
            } else {
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                joinBtn.disabled = true;
                pingBtn.disabled = true;
                chatInput.disabled = true;
                chatBtn.disabled = true;

                // Clear session info
                document.getElementById('playerId').textContent = '-';
                document.getElementById('username').textContent = '-';
                document.getElementById('sessionId').textContent = '-';
                document.getElementById('playerCount').textContent = '0';
                document.getElementById('sessionState').textContent = '-';
            }
        }

        function addMessage(type, text) {
            const messagesDiv = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;

            const timestamp = new Date().toLocaleTimeString();
            messageEl.innerHTML = `<span class="timestamp">${timestamp}</span><span class="message-type">[${type}]</span>${text}`;

            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Add initial message
        addMessage('system', 'Test client loaded. Click Connect to start.');
    </script>
</body>
</html>
